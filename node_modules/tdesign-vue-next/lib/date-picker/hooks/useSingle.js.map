{"version":3,"file":"useSingle.js","sources":["../../../src/date-picker/hooks/useSingle.tsx"],"sourcesContent":["import { ref, computed, watchEffect } from 'vue';\nimport { CalendarIcon as TdCalendarIcon } from 'tdesign-icons-vue-next';\nimport dayjs from 'dayjs';\n\nimport { useFormDisabled } from '../../form/hooks';\nimport { usePrefixClass, useConfig } from '../../hooks/useConfig';\nimport { useGlobalIcon } from '../../hooks/useGlobalIcon';\nimport { TdDatePickerProps, DateValue } from '../type';\nimport { isValidDate, formatDate, formatTime, getDefaultFormat } from '../../_common/js/date-picker/format';\nimport useSingleValue from './useSingleValue';\n\nexport default function useSingle(props: TdDatePickerProps) {\n  const COMPONENT_NAME = usePrefixClass('date-picker');\n  const { globalConfig } = useConfig('datePicker');\n  const { CalendarIcon } = useGlobalIcon({ CalendarIcon: TdCalendarIcon });\n  const disabled = useFormDisabled();\n\n  const inputRef = ref();\n\n  const { value, onChange, time, month, year, cacheValue } = useSingleValue(props);\n\n  const formatRef = computed(() =>\n    getDefaultFormat({\n      mode: props.mode,\n      format: props.format,\n      valueType: props.valueType,\n      enableTimePicker: props.enableTimePicker,\n    }),\n  );\n\n  const popupVisible = ref(false);\n  const isHoverCell = ref(false);\n  // 未真正选中前可能不断变更输入框的内容\n  const inputValue = ref(\n    formatDate(value.value, { format: formatRef.value.format, targetFormat: formatRef.value.format }),\n  );\n\n  // input 设置\n  const inputProps = computed(() => ({\n    ...props.inputProps,\n    ref: inputRef,\n    prefixIcon: props.prefixIcon,\n    readonly: !props.allowInput,\n    placeholder: props.placeholder || globalConfig.value.placeholder[props.mode],\n    suffixIcon: props.suffixIcon || (() => <CalendarIcon />),\n    class: [\n      {\n        [`${COMPONENT_NAME.value}__input--placeholder`]: isHoverCell.value,\n      },\n    ],\n    onClear: (context: { e: InputEvent }) => {\n      context?.e?.stopPropagation();\n      popupVisible.value = false;\n      onChange?.('', { dayjsValue: dayjs(''), trigger: 'clear' });\n    },\n    onBlur: (val: string, context: { e: FocusEvent }) => {\n      props.onBlur?.({ value: val, e: context.e });\n    },\n    onFocus: (_: string, { e }: { e: FocusEvent }) => {\n      props.onFocus?.({ value: value.value, e });\n    },\n    onChange: (val: string) => {\n      // 输入事件\n      inputValue.value = val;\n\n      // 跳过不符合格式化的输入框内容\n      if (!isValidDate(val, formatRef.value.format)) return;\n      const newMonth = dayjs(val).month();\n      const newYear = dayjs(val).year();\n      const newTime = formatTime(val, formatRef.value.timeFormat);\n      !Number.isNaN(newYear) && (year.value = newYear);\n      !Number.isNaN(newMonth) && (month.value = newMonth);\n      !Number.isNaN(newTime) && (time.value = newTime);\n    },\n    onEnter: (val: string) => {\n      if (!isValidDate(val, formatRef.value.format) && !isValidDate(value.value, formatRef.value.format)) return;\n\n      popupVisible.value = false;\n      if (isValidDate(val, formatRef.value.format)) {\n        onChange?.(\n          formatDate(val, { format: formatRef.value.format, targetFormat: formatRef.value.valueType }) as DateValue,\n          {\n            dayjsValue: dayjs(val),\n            trigger: 'enter',\n          },\n        );\n      } else if (isValidDate(value.value, formatRef.value.format)) {\n        inputValue.value = formatDate(value.value, {\n          format: formatRef.value.format,\n          targetFormat: formatRef.value.format,\n        });\n      } else {\n        inputValue.value = '';\n      }\n    },\n  }));\n\n  // popup 设置\n  const popupProps = computed(() => ({\n    expandAnimation: true,\n    ...props.popupProps,\n    disabled: disabled.value,\n    overlayInnerStyle: props.popupProps?.overlayInnerStyle ?? { width: 'auto' },\n    overlayClassName: [props.popupProps?.overlayClassName, `${COMPONENT_NAME.value}__panel-container`],\n    onVisibleChange: (visible: boolean, context: any) => {\n      if (disabled.value) return;\n\n      // 输入框点击不关闭面板\n      if (context.trigger === 'trigger-element-click') {\n        popupVisible.value = true;\n        return;\n      }\n      if (!visible) {\n        isHoverCell.value = false;\n        inputValue.value = formatDate(value.value, {\n          format: formatRef.value.format,\n          targetFormat: formatRef.value.format,\n        });\n      }\n      popupVisible.value = visible;\n    },\n  }));\n\n  watchEffect(() => {\n    if (!value.value) {\n      inputValue.value = '';\n      return;\n    }\n    if (!isValidDate(value.value, formatRef.value.valueType)) return;\n\n    inputValue.value = formatDate(value.value, {\n      format: formatRef.value.format,\n      targetFormat: formatRef.value.format,\n    });\n  });\n\n  return {\n    year,\n    month,\n    value,\n    time,\n    inputValue,\n    popupVisible,\n    inputProps,\n    popupProps,\n    inputRef,\n    cacheValue,\n    isHoverCell,\n    onChange,\n  };\n}\n"],"names":["useSingle","props","COMPONENT_NAME","usePrefixClass","useConfig","globalConfig","useGlobalIcon","CalendarIcon","TdCalendarIcon","disabled","useFormDisabled","inputRef","ref","useSingleValue","value","onChange","time","month","year","cacheValue","formatRef","computed","getDefaultFormat","mode","format","valueType","enableTimePicker","popupVisible","isHoverCell","inputValue","formatDate","targetFormat","inputProps","prefixIcon","readonly","allowInput","placeholder","suffixIcon","_createVNode","onClear","context","e","stopPropagation","dayjsValue","dayjs","trigger","onBlur","val","onFocus","_","isValidDate","newMonth","newYear","newTime","formatTime","timeFormat","Number","isNaN","onEnter","popupProps","expandAnimation","overlayInnerStyle","width","overlayClassName","onVisibleChange","visible","watchEffect"],"mappings":"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"}