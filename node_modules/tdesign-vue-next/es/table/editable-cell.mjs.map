{"version":3,"file":"editable-cell.mjs","sources":["../../src/table/editable-cell.tsx"],"sourcesContent":["import { computed, defineComponent, PropType, ref, SetupContext, toRefs, watch } from 'vue';\nimport get from 'lodash/get';\nimport set from 'lodash/set';\nimport isFunction from 'lodash/isFunction';\nimport { Edit1Icon as TdEdit1Icon } from 'tdesign-icons-vue-next';\n\nimport {\n  TableRowData,\n  PrimaryTableCol,\n  PrimaryTableRowEditContext,\n  PrimaryTableRowValidateContext,\n  TdBaseTableProps,\n  PrimaryTableCellParams,\n} from './type';\nimport { TableClassName } from './hooks/useClassName';\nimport { useGlobalIcon } from '../hooks/useGlobalIcon';\nimport { renderCell } from './tr';\nimport { validate } from '../form/form-model';\nimport log from '../_common/js/log';\nimport { AllValidateResult } from '../form/type';\n\nexport interface EditableCellProps {\n  row: TableRowData;\n  rowIndex: number;\n  col: PrimaryTableCol<TableRowData>;\n  colIndex: number;\n  oldCell: PrimaryTableCol<TableRowData>['cell'];\n  tableBaseClass?: TableClassName['tableBaseClass'];\n  /** 行编辑需要使用 editable。单元格编辑则无需使用，设置为 undefined */\n  editable?: boolean;\n  readonly?: boolean;\n  errors?: AllValidateResult[];\n  cellEmptyContent?: TdBaseTableProps['cellEmptyContent'];\n  onChange?: (context: PrimaryTableRowEditContext<TableRowData>) => void;\n  onValidate?: (context: PrimaryTableRowValidateContext<TableRowData>) => void;\n  onRuleChange?: (context: PrimaryTableRowEditContext<TableRowData>) => void;\n}\n\nexport default defineComponent({\n  name: 'TableEditableCell',\n  props: {\n    row: Object as PropType<EditableCellProps['row']>,\n    rowIndex: Number,\n    col: Object as PropType<EditableCellProps['col']>,\n    colIndex: Number,\n    oldCell: [Function, String] as PropType<EditableCellProps['oldCell']>,\n    tableBaseClass: Object as PropType<EditableCellProps['tableBaseClass']>,\n    cellEmptyContent: [Function, String] as PropType<EditableCellProps['cellEmptyContent']>,\n    editable: {\n      type: Boolean,\n      default: undefined,\n    },\n    readonly: {\n      type: Boolean,\n    },\n    errors: {\n      type: Array as PropType<EditableCellProps['errors']>,\n      default: undefined,\n    },\n    onChange: Function as PropType<EditableCellProps['onChange']>,\n    onValidate: Function as PropType<EditableCellProps['onValidate']>,\n    onRuleChange: Function as PropType<EditableCellProps['onRuleChange']>,\n  },\n\n  setup(props: EditableCellProps, context: SetupContext) {\n    const { row, col } = toRefs(props);\n    const tableEditableCellRef = ref(null);\n    const isEdit = ref(props.col.edit?.defaultEditable || false);\n    const editValue = ref();\n    const errorList = ref<AllValidateResult[]>();\n\n    const { Edit1Icon } = useGlobalIcon({ Edit1Icon: TdEdit1Icon });\n\n    const currentRow = computed(() => {\n      const newRow = { ...row.value };\n      set(newRow, col.value.colKey, editValue.value);\n      return newRow;\n    });\n\n    const cellNode = computed(() => {\n      const node = renderCell(\n        {\n          row: currentRow.value,\n          col: { ...col.value, cell: props.oldCell },\n          rowIndex: props.rowIndex,\n          colIndex: props.colIndex,\n        },\n        context.slots,\n        { cellEmptyContent: props.cellEmptyContent },\n      );\n      return node;\n    });\n\n    const componentProps = computed(() => {\n      const { edit } = col.value;\n      if (!edit) return {};\n      const editProps = isFunction(edit.props)\n        ? edit.props({\n            col: col.value,\n            row: row.value,\n            rowIndex: props.rowIndex,\n            colIndex: props.colIndex,\n            editedRow: currentRow.value,\n          })\n        : { ...edit.props };\n      // to remove warn: runtime-core.esm-bundler.js:38 [Vue warn]: Invalid prop: type check failed for prop \"onChange\". Expected Function, got Array\n      delete editProps.onChange;\n      delete editProps.value;\n      edit.abortEditOnEvent?.forEach((item) => {\n        delete editProps[item];\n      });\n      return editProps;\n    });\n\n    const isAbortEditOnChange = computed(() => {\n      const { edit } = col.value;\n      if (!edit) return false;\n      return Boolean(edit.abortEditOnEvent?.includes('onChange'));\n    });\n\n    const validateEdit = (trigger: 'self' | 'parent') => {\n      return new Promise((resolve) => {\n        const cellParams: PrimaryTableCellParams<TableRowData> = {\n          col: props.col,\n          row: props.row,\n          colIndex: props.colIndex,\n          rowIndex: props.rowIndex,\n        };\n        const params: PrimaryTableRowValidateContext<TableRowData> = {\n          result: [\n            {\n              ...cellParams,\n              errorList: [],\n              value: editValue.value,\n            },\n          ],\n          trigger,\n        };\n        const rules = isFunction(col.value.edit.rules) ? col.value.edit.rules(cellParams) : col.value.edit.rules;\n        if (!col.value.edit || !rules || !rules.length) {\n          props.onValidate?.(params);\n          resolve(true);\n          return;\n        }\n        validate(editValue.value, rules).then((result) => {\n          const list = result?.filter((t) => !t.result);\n          params.result[0].errorList = list;\n          props.onValidate?.(params);\n          if (!list || !list.length) {\n            resolve(true);\n          } else {\n            errorList.value = list;\n            resolve(list);\n          }\n        });\n      });\n    };\n\n    const isSame = (a: any, b: any) => {\n      if (typeof a === 'object' && typeof b === 'object') {\n        return JSON.stringify(a) === JSON.stringify(b);\n      }\n      return a === b;\n    };\n\n    const updateAndSaveAbort = (outsideAbortEvent: Function, ...args: any) => {\n      validateEdit('self').then((result) => {\n        if (result !== true) return;\n        const oldValue = get(row.value, col.value.colKey);\n        // 相同的值无需触发变化\n        if (!isSame(editValue.value, oldValue)) {\n          editValue.value = oldValue;\n          outsideAbortEvent?.(...args);\n        }\n        // 此处必须在事件执行完成后异步销毁编辑组件，否则会导致事件清楚不及时引起的其他问题\n        const timer = setTimeout(() => {\n          isEdit.value = false;\n          errorList.value = [];\n          clearTimeout(timer);\n        }, 0);\n      });\n    };\n\n    const listeners = computed<{ [key: string]: Function }>(() => {\n      const { edit } = col.value;\n      const isCellEditable = props.editable === undefined;\n      if (!isEdit.value || !isCellEditable) return;\n      if (!edit?.abortEditOnEvent?.length) return {};\n      // 自定义退出编辑态的事件\n      const tListeners = {};\n      const outsideAbortEvent = edit?.onEdited;\n      edit.abortEditOnEvent.forEach((itemEvent) => {\n        if (itemEvent === 'onChange') return;\n        tListeners[itemEvent] = (...args: any) => {\n          updateAndSaveAbort(\n            outsideAbortEvent,\n            {\n              trigger: itemEvent,\n              newRowData: currentRow.value,\n              rowIndex: props.rowIndex,\n            },\n            ...args,\n          );\n        };\n      });\n\n      return tListeners;\n    });\n\n    const onEditChange = (val: any, ...args: any) => {\n      editValue.value = val;\n      const params = {\n        row: props.row,\n        rowIndex: props.rowIndex,\n        value: val,\n        col: props.col,\n        colIndex: props.colIndex,\n        editedRow: { ...props.row, [props.col.colKey]: val },\n      };\n      props.onChange?.(params);\n      props.onRuleChange?.(params);\n      const isCellEditable = props.editable === undefined;\n      if (isCellEditable && isAbortEditOnChange.value) {\n        const outsideAbortEvent = col.value.edit?.onEdited;\n        updateAndSaveAbort(\n          outsideAbortEvent,\n          {\n            trigger: 'onChange',\n            newRowData: currentRow.value,\n            rowIndex: props.rowIndex,\n          },\n          ...args,\n        );\n      }\n    };\n\n    const documentClickHandler = (e: PointerEvent) => {\n      if (!col.value.edit || !col.value.edit.component) return;\n      if (!isEdit.value) return;\n      // @ts-ignore\n      if (e.path?.includes(tableEditableCellRef.value?.$el)) return;\n      // @ts-ignore 如果点击到 Popup 复层也直接返回\n      for (let i = 0, len = e.path.length; i < len; i++) {\n        // @ts-ignore\n        const node = e.path[i];\n        if (node.classList?.value?.includes('popup__content')) {\n          return;\n        }\n      }\n      const outsideAbortEvent = col.value.edit.onEdited;\n      updateAndSaveAbort(outsideAbortEvent, {\n        trigger: 'document',\n        newRowData: currentRow.value,\n        rowIndex: props.rowIndex,\n      });\n    };\n\n    const cellValue = computed(() => get(row.value, col.value.colKey));\n\n    watch(\n      cellValue,\n      (cellValue) => {\n        let val = cellValue;\n        if (typeof val === 'object' && val !== null) {\n          val = val instanceof Array ? [...val] : { ...val };\n        }\n        editValue.value = val;\n      },\n      { immediate: true },\n    );\n\n    watch(\n      isEdit,\n      (isEdit) => {\n        const isCellEditable = props.editable === undefined;\n        if (!col.value.edit || !col.value.edit.component || !isCellEditable) return;\n        if (isEdit) {\n          document.addEventListener('click', documentClickHandler);\n        } else {\n          document.removeEventListener('click', documentClickHandler);\n        }\n      },\n      { immediate: true },\n    );\n\n    watch(\n      () => [props.editable, props.rowIndex, props.colIndex],\n      ([editable, rowIndex, colIndex]: [boolean, number, number]) => {\n        // 退出编辑态时，恢复原始值，等待父组件传入新的 data 值\n        if (editable === false) {\n          editValue.value = cellValue.value;\n        } else if (editable === true) {\n          props.onRuleChange?.({\n            col: col.value,\n            row: row.value,\n            rowIndex,\n            colIndex,\n            value: cellValue.value,\n            editedRow: row.value,\n          });\n        }\n      },\n      { immediate: true },\n    );\n\n    watch(\n      () => props.errors,\n      (errors) => {\n        errorList.value = errors;\n      },\n    );\n\n    return () => {\n      if (props.readonly) {\n        return cellNode.value;\n      }\n      // props.editable = undefined 表示由组件内部控制编辑状态\n      if ((props.editable === undefined && !isEdit.value) || props.editable === false) {\n        return (\n          <div\n            class={props.tableBaseClass.cellEditable}\n            onClick={(e: MouseEvent) => {\n              isEdit.value = true;\n              e.stopPropagation();\n            }}\n          >\n            {cellNode.value}\n            {col.value.edit?.showEditIcon !== false && <Edit1Icon size=\"12px\" />}\n          </div>\n        );\n      }\n      const Component = col.value.edit?.component;\n      if (!Component) {\n        log.error('Table', 'edit.component is required.');\n        return null;\n      }\n      const errorMessage = errorList.value?.[0]?.message;\n      return (\n        <div\n          class={props.tableBaseClass.cellEditWrap}\n          onClick={(e: MouseEvent) => {\n            e.stopPropagation();\n          }}\n        >\n          <Component\n            ref=\"tableEditableCellRef\"\n            status={errorMessage ? errorList.value?.[0]?.type || 'error' : undefined}\n            tips={errorMessage}\n            {...componentProps.value}\n            {...listeners.value}\n            value={editValue.value}\n            onChange={onEditChange}\n          />\n        </div>\n      );\n    };\n  },\n});\n"],"names":["defineComponent","name","props","row","Object","rowIndex","Number","col","colIndex","oldCell","Function","String","tableBaseClass","cellEmptyContent","editable","type","Boolean","readonly","errors","Array","onChange","onValidate","onRuleChange","setup","context","toRefs","tableEditableCellRef","ref","isEdit","edit","defaultEditable","editValue","errorList","useGlobalIcon","Edit1Icon","TdEdit1Icon","currentRow","computed","newRow","value","set","colKey","cellNode","node","renderCell","cell","slots","componentProps","editProps","isFunction","editedRow","abortEditOnEvent","forEach","item","isAbortEditOnChange","includes","validateEdit","trigger","Promise","resolve","cellParams","params","result","rules","length","validate","then","list","filter","t","isSame","a","b","JSON","stringify","updateAndSaveAbort","outsideAbortEvent","args","oldValue","get","timer","setTimeout","clearTimeout","listeners","isCellEditable","tListeners","onEdited","itemEvent","newRowData","onEditChange","val","documentClickHandler","e","component","path","$el","i","len","classList","cellValue","watch","immediate","document","addEventListener","removeEventListener","_createVNode","cellEditable","stopPropagation","showEditIcon","Component","log","error","errorMessage","message","cellEditWrap","_mergeProps"],"mappings":"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"}