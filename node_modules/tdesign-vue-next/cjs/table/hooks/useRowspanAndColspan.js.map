{"version":3,"file":"useRowspanAndColspan.js","sources":["../../../src/table/hooks/useRowspanAndColspan.ts"],"sourcesContent":["import { ref, watch, Ref } from 'vue';\nimport get from 'lodash/get';\nimport log from '../../_common/js/log';\nimport { BaseTableCellParams, BaseTableCol, TableRowData, TableRowspanAndColspanFunc } from '../type';\n\nexport interface SkipSpansValue {\n  colspan?: number;\n  rowspan?: number;\n  skipped?: boolean;\n}\n\nexport function getCellKey(row: TableRowData, rowKey: string, colKey: string, colIndex: number) {\n  const rowValue = get(row, rowKey);\n  if (rowValue === undefined) {\n    log.error('Table', 'rowKey is wrong, can not get unique identifier of row.');\n  }\n  return [rowValue, colKey || colIndex].join('_');\n}\n\nexport default function useRowspanAndColspan(\n  data: Ref<TableRowData[]>,\n  columns: Ref<BaseTableCol<TableRowData>[]>,\n  rowKey: Ref<string>,\n  rowspanAndColspan: Ref<TableRowspanAndColspanFunc<TableRowData>>,\n) {\n  const skipSpansMap = ref(new Map<string, SkipSpansValue>());\n\n  // 计算单元格是否跳过渲染\n  const onTrRowspanOrColspan = (params: BaseTableCellParams<TableRowData>, skipSpansValue: SkipSpansValue) => {\n    const { rowIndex, colIndex } = params;\n    if (!skipSpansValue.rowspan && !skipSpansValue.colspan) return;\n    const maxRowIndex = rowIndex + (skipSpansValue.rowspan || 1);\n    const maxColIndex = colIndex + (skipSpansValue.colspan || 1);\n    for (let i = rowIndex; i < maxRowIndex; i++) {\n      for (let j = colIndex; j < maxColIndex; j++) {\n        if (i !== rowIndex || j !== colIndex) {\n          if (!data.value[i] || !columns.value[j]) return;\n          const cellKey = getCellKey(data.value[i], rowKey.value, columns.value[j].colKey, j);\n          const state = skipSpansMap.value.get(cellKey) || {};\n          state.skipped = true;\n          skipSpansMap.value.set(cellKey, state);\n        }\n      }\n    }\n  };\n\n  // 计算单元格是否需要设置 rowspan 和 colspan\n  const updateSkipSpansMap = (\n    data: TableRowData[],\n    columns: BaseTableCol<TableRowData>[],\n    rowspanAndColspan: TableRowspanAndColspanFunc<TableRowData>,\n  ) => {\n    skipSpansMap.value?.clear();\n    if (!data || !rowspanAndColspan) return;\n    for (let i = 0, len = data.length; i < len; i++) {\n      const row = data[i];\n      for (let j = 0, colLen = columns.length; j < colLen; j++) {\n        const col = columns[j];\n        const params = {\n          row,\n          col,\n          rowIndex: i,\n          colIndex: j,\n        };\n        const cellKey = getCellKey(row, rowKey.value, col.colKey, j);\n        const state = skipSpansMap.value.get(cellKey) || {};\n        const o = rowspanAndColspan(params) || {};\n        if (o.rowspan || o.colspan || state.rowspan || state.colspan) {\n          o.rowspan && (state.rowspan = o.rowspan);\n          o.colspan && (state.colspan = o.colspan);\n          skipSpansMap.value.set(cellKey, state);\n        }\n        onTrRowspanOrColspan?.(params, state);\n      }\n    }\n  };\n\n  watch(\n    () => [data.value, columns.value, rowspanAndColspan],\n    () => {\n      updateSkipSpansMap(data.value, columns.value, rowspanAndColspan?.value);\n    },\n    { immediate: true },\n  );\n\n  return { skipSpansMap };\n}\n"],"names":["getCellKey","row","rowKey","colKey","colIndex","rowValue","get","log","error","join","useRowspanAndColspan","data","columns","rowspanAndColspan","skipSpansMap","ref","Map","onTrRowspanOrColspan","params","skipSpansValue","rowIndex","rowspan","colspan","maxRowIndex","maxColIndex","i","j","value","cellKey","state","skipped","set","updateSkipSpansMap","clear","len","length","colLen","col","o","watch","immediate"],"mappings":"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"}