/**
 * tdesign v0.21.1
 * (c) 2022 tdesign
 * @license MIT
 */

'use strict';

Object.defineProperty(exports, '__esModule', { value: true });

var _defineProperty = require('@babel/runtime/helpers/defineProperty');
var _slicedToArray = require('@babel/runtime/helpers/slicedToArray');
var vue = require('vue');
var tdesignIconsVueNext = require('tdesign-icons-vue-next');
var upload_dragger = require('./dragger.js');
var upload_image = require('./image.js');
var upload_flowList = require('./flow-list.js');
var button_index = require('../button/index.js');
var dialog_index = require('../dialog/index.js');
var upload_singleFile = require('./single-file.js');
var upload_props = require('./props.js');
var form_hooks = require('../form/hooks.js');
var upload_hooks = require('./hooks.js');
var hooks_useGlobalIcon = require('../hooks/useGlobalIcon.js');
var hooks_useConfig = require('../hooks/useConfig.js');
var hooks_tnode = require('../hooks/tnode.js');
var hooks_useVModel = require('../hooks/useVModel.js');
var configProvider_useConfig = require('../config-provider/useConfig.js');
require('../loading/index.js');
require('../loading/directive.js');
require('../loading/plugin.js');
require('../loading/loading.js');
require('../loading/icon/gradient.js');
require('../_common/js/loading/circle-adapter.js');
require('../_common/js/utils/set-style.js');
require('../_common/js/utils/helper.js');
require('@babel/runtime/helpers/toConsumableArray');
require('@babel/runtime/helpers/objectWithoutProperties');
require('../utils/dom.js');
require('../_chunks/dep-68610cdc.js');
require('lodash/isString');
require('../utils/easing.js');
require('../utils/render-tnode.js');
require('lodash/isEmpty');
require('lodash/isFunction');
require('lodash/isObject');
require('lodash/camelCase');
require('lodash/kebabCase');
require('../utils/transfer-dom.js');
require('../loading/props.js');
require('../config-provider/context.js');
require('lodash/mergeWith');
require('lodash/merge');
require('../_common/js/global-config/default-config.js');
require('../_common/js/global-config/locale/zh_CN.js');
require('../utils/withInstall.js');
require('./util.js');
require('../button/button.js');
require('../button/props.js');
require('../hooks/useRipple.js');
require('../hooks/useKeepAnimation.js');
require('../utils/set-style.js');
require('../dialog/dialog.js');
require('../dialog/props.js');
require('../dialog/hooks.js');
require('@babel/runtime/helpers/typeof');
require('../hooks/useDestroyOnClose.js');
require('../dialog/stack.js');
require('../dialog/plugin.js');
require('lodash/findIndex');
require('../_common/js/log/log.js');
require('./useUpload.js');
require('@babel/runtime/helpers/asyncToGenerator');
require('@babel/runtime/regenerator');
require('lodash/without');
require('../_common/js/upload/xhr.js');

function _interopDefaultLegacy (e) { return e && typeof e === 'object' && 'default' in e ? e : { 'default': e }; }

var _defineProperty__default = /*#__PURE__*/_interopDefaultLegacy(_defineProperty);
var _slicedToArray__default = /*#__PURE__*/_interopDefaultLegacy(_slicedToArray);

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); enumerableOnly && (symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; })), keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = null != arguments[i] ? arguments[i] : {}; i % 2 ? ownKeys(Object(source), !0).forEach(function (key) { _defineProperty__default["default"](target, key, source[key]); }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)) : ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } return target; }

function _isSlot(s) {
  return typeof s === 'function' || Object.prototype.toString.call(s) === '[object Object]' && !vue.isVNode(s);
}

var _Upload = vue.defineComponent({
  name: "TUpload",
  props: upload_props["default"],
  setup: function setup(props2, _ref) {
    var expose = _ref.expose;
    var renderTNodeContent = hooks_tnode.useContent();

    var _useConfig = configProvider_useConfig.useConfig("upload"),
        prefix = _useConfig.classPrefix,
        globalConfig = _useConfig.globalConfig;

    var UPLOAD_NAME = hooks_useConfig.usePrefixClass("upload");

    var _useGlobalIcon = hooks_useGlobalIcon.useGlobalIcon({
      UploadIcon: tdesignIconsVueNext.UploadIcon
    }),
        UploadIcon = _useGlobalIcon.UploadIcon;

    var _toRefs = vue.toRefs(props2),
        files = _toRefs.files,
        modelValue = _toRefs.modelValue;

    var _useBatchUpload = upload_hooks.useBatchUpload(props2),
        canBatchUpload = _useBatchUpload.canBatchUpload,
        uploadInOneRequest = _useBatchUpload.uploadInOneRequest;

    var _useVModel = hooks_useVModel["default"](files, modelValue, props2.defaultFiles || [], props2.onChange, "files"),
        _useVModel2 = _slicedToArray__default["default"](_useVModel, 2),
        uploadValue = _useVModel2[0],
        setUploadValue = _useVModel2[1];

    var uploadCtx = vue.reactive({
      uploadValue: uploadValue,
      setUploadValue: setUploadValue,
      uploadInOneRequest: uploadInOneRequest,
      canBatchUpload: canBatchUpload,
      loadingFile: null,
      percent: 0,
      toUploadFiles: [],
      errorMsg: ""
    });
    var disabled = form_hooks.useFormDisabled();

    var _useComponentsStatus = upload_hooks.useComponentsStatus(props2, uploadCtx),
        showUploadList = _useComponentsStatus.showUploadList,
        showTips = _useComponentsStatus.showTips,
        showErrorMsg = _useComponentsStatus.showErrorMsg,
        singleDraggable = _useComponentsStatus.singleDraggable;

    var _useImgPreview = upload_hooks.useImgPreview(props2),
        showImageViewUrl = _useImgPreview.showImageViewUrl,
        showImageViewDialog = _useImgPreview.showImageViewDialog,
        handlePreviewImg = _useImgPreview.handlePreviewImg,
        cancelPreviewImgDialog = _useImgPreview.cancelPreviewImgDialog;

    var _useDragger = upload_hooks.useDragger(props2, disabled),
        handleDragenter = _useDragger.handleDragenter,
        handleDragleave = _useDragger.handleDragleave,
        dragActive = _useDragger.dragActive;

    var _useRemove = upload_hooks.useRemove(props2, uploadCtx),
        handleFileInputRemove = _useRemove.handleFileInputRemove,
        handleSingleRemove = _useRemove.handleSingleRemove,
        handleMultipleRemove = _useRemove.handleMultipleRemove,
        handleListRemove = _useRemove.handleListRemove;

    var _useActions = upload_hooks.useActions(props2, uploadCtx, disabled),
        handleChange = _useActions.handleChange,
        multipleUpload = _useActions.multipleUpload,
        triggerUpload = _useActions.triggerUpload,
        cancelUpload = _useActions.cancelUpload,
        handleDragChange = _useActions.handleDragChange,
        upload = _useActions.upload,
        inputRef = _useActions.inputRef;

    expose({
      triggerUpload: triggerUpload,
      setPercent: function setPercent(val) {
        uploadCtx.percent = val;
      }
    });

    var renderInput = function renderInput() {
      return vue.createVNode("input", {
        "ref": inputRef,
        "type": "file",
        "disabled": disabled.value,
        "onChange": handleChange,
        "multiple": props2.multiple,
        "accept": props2.accept,
        "hidden": true
      }, null);
    };

    var renderSingleDisplay = function renderSingleDisplay(triggerElement) {
      var _uploadValue$value;

      return !props2.draggable && ["file", "file-input"].includes(props2.theme) && vue.createVNode(upload_singleFile["default"], {
        "file": uploadValue.value && uploadValue.value[0],
        "loadingFile": uploadCtx.loadingFile,
        "percent": uploadCtx.percent,
        "theme": props2.theme,
        "onRemove": handleSingleRemove,
        "showUploadProgress": props2.showUploadProgress,
        "placeholder": props2.placeholder
      }, {
        "default": function _default() {
          return [vue.createVNode("div", {
            "class": "".concat(prefix.value, "-upload__trigger"),
            "onclick": triggerUpload
          }, [triggerElement, !!(props2.theme === "file-input" && (_uploadValue$value = uploadValue.value) !== null && _uploadValue$value !== void 0 && _uploadValue$value.length) && vue.createVNode(button_index.Button, {
            "theme": "primary",
            "variant": "text",
            "onClick": handleFileInputRemove
          }, {
            "default": function _default() {
              return ["\u5220\u9664"];
            }
          })])];
        }
      });
    };

    var renderDraggerTrigger = function renderDraggerTrigger() {
      var params = {
        dragActive: dragActive.value,
        uploadingFile: props2.multiple ? uploadCtx.toUploadFiles : uploadCtx.loadingFile
      };
      var triggerElement = renderTNodeContent("default", "trigger", {
        params: params
      });

      if (!Array.isArray(triggerElement)) {
        triggerElement = {};
      }

      return vue.createVNode(upload_dragger["default"], {
        "showUploadProgress": props2.showUploadProgress,
        "loadingFile": uploadCtx.loadingFile,
        "percent": uploadCtx.percent,
        "file": uploadValue.value && uploadValue.value[0],
        "theme": props2.theme,
        "autoUpload": props2.autoUpload,
        "onChange": handleDragChange,
        "onDragenter": handleDragenter,
        "onDragleave": handleDragleave,
        "onCancel": cancelUpload,
        "onClick": triggerUpload,
        "onRemove": handleSingleRemove,
        "onUpload": upload,
        "locale": props2.locale
      }, _isSlot(triggerElement) ? triggerElement : {
        "default": function _default() {
          return [triggerElement];
        }
      });
    };

    var uploadListTriggerText = vue.computed(function () {
      var _localeFromProps$trig, _uploadCtx$toUploadFi, _uploadCtx$uploadValu;

      var localeFromProps = props2.locale;
      var uploadText = globalConfig.value.triggerUploadText.fileInput || (localeFromProps === null || localeFromProps === void 0 ? void 0 : (_localeFromProps$trig = localeFromProps.triggerUploadText) === null || _localeFromProps$trig === void 0 ? void 0 : _localeFromProps$trig.fileInput);

      if (((_uploadCtx$toUploadFi = uploadCtx.toUploadFiles) === null || _uploadCtx$toUploadFi === void 0 ? void 0 : _uploadCtx$toUploadFi.length) > 0 || ((_uploadCtx$uploadValu = uploadCtx.uploadValue) === null || _uploadCtx$uploadValu === void 0 ? void 0 : _uploadCtx$uploadValu.length) > 0) {
        var _uploadCtx$uploadValu2;

        if (props2.theme === "file-input" || ((_uploadCtx$uploadValu2 = uploadCtx.uploadValue) === null || _uploadCtx$uploadValu2 === void 0 ? void 0 : _uploadCtx$uploadValu2.length) > 0 && canBatchUpload.value) {
          var _localeFromProps$trig2;

          uploadText = (localeFromProps === null || localeFromProps === void 0 ? void 0 : (_localeFromProps$trig2 = localeFromProps.triggerUploadText) === null || _localeFromProps$trig2 === void 0 ? void 0 : _localeFromProps$trig2.reupload) || globalConfig.value.triggerUploadText.reupload;
        } else {
          var _localeFromProps$trig3;

          uploadText = (localeFromProps === null || localeFromProps === void 0 ? void 0 : (_localeFromProps$trig3 = localeFromProps.triggerUploadText) === null || _localeFromProps$trig3 === void 0 ? void 0 : _localeFromProps$trig3.continueUpload) || globalConfig.value.triggerUploadText.continueUpload;
        }
      }

      return uploadText;
    });

    var renderTrigger = function renderTrigger() {
      var getDefaultTrigger = function getDefaultTrigger() {
        var localeFromProps = props2.locale;

        if (props2.theme === "file-input" || showUploadList.value) {
          var _localeFromProps$trig4;

          return vue.createVNode(vue.resolveComponent("t-button"), {
            "variant": "outline"
          }, {
            "default": function _default() {
              return [(localeFromProps === null || localeFromProps === void 0 ? void 0 : (_localeFromProps$trig4 = localeFromProps.triggerUploadText) === null || _localeFromProps$trig4 === void 0 ? void 0 : _localeFromProps$trig4.fileInput) || globalConfig.value.triggerUploadText.fileInput];
            }
          });
        }

        var iconSlot = {
          icon: function icon() {
            return vue.createVNode(UploadIcon, null, null);
          }
        };
        return vue.createVNode(button_index.Button, {
          "variant": "outline"
        }, _objectSpread({
          "default": function _default() {
            return [uploadListTriggerText.value];
          }
        }, iconSlot));
      };

      var defaultNode = getDefaultTrigger();
      return renderTNodeContent("default", "trigger", defaultNode);
    };

    var renderCustom = function renderCustom(triggerElement) {
      if (props2.theme !== "custom") return;
      return props2.draggable ? renderDraggerTrigger() : vue.createVNode("div", {
        "class": "".concat(UPLOAD_NAME.value, "__trigger"),
        "onclick": triggerUpload
      }, [triggerElement]);
    };

    var renderImgCard = function renderImgCard() {
      return !props2.draggable && props2.theme === "image" && vue.createVNode(upload_image["default"], {
        "files": uploadValue.value,
        "loadingFile": uploadCtx.loadingFile,
        "percent": uploadCtx.percent,
        "showUploadProgress": props2.showUploadProgress,
        "placeholder": props2.placeholder,
        "multiple": props2.multiple,
        "max": props2.max,
        "disabled": disabled.value,
        "onClick": triggerUpload,
        "onRemove": handleMultipleRemove,
        "onImgPreview": handlePreviewImg,
        "locale": props2.locale
      }, null);
    };

    var renderFlowList = function renderFlowList(triggerElement) {
      var theme = props2.theme;

      if (props2.multiple && props2.theme === "file" && props2.draggable) {
        theme = "file-flow";
      }

      return showUploadList.value && vue.createVNode(upload_flowList["default"], {
        "files": uploadValue.value,
        "placeholder": props2.placeholder,
        "autoUpload": props2.autoUpload,
        "toUploadFiles": uploadCtx.toUploadFiles,
        "theme": theme,
        "batchUpload": uploadCtx.canBatchUpload,
        "showUploadProgress": props2.showUploadProgress,
        "allowUploadDuplicateFile": props2.allowUploadDuplicateFile,
        "onRemove": handleListRemove,
        "onUpload": multipleUpload,
        "onCancel": cancelUpload,
        "onImgPreview": handlePreviewImg,
        "onChange": handleDragChange,
        "onDragenter": handleDragenter,
        "onDragleave": handleDragleave,
        "locale": props2.locale
      }, {
        "default": function _default() {
          return [vue.createVNode("div", {
            "class": "".concat(UPLOAD_NAME.value, "__trigger"),
            "onclick": triggerUpload
          }, [triggerElement])];
        }
      });
    };

    var renderDialog = function renderDialog() {
      return ["image", "image-flow", "custom"].includes(props2.theme) && vue.createVNode(dialog_index.Dialog, {
        "visible": showImageViewDialog.value,
        "showOverlay": true,
        "width": "auto",
        "top": "10%",
        "class": "".concat(UPLOAD_NAME.value, "__dialog"),
        "footer": false,
        "header": false,
        "onClose": cancelPreviewImgDialog
      }, {
        "default": function _default() {
          return [vue.createVNode("div", {
            "class": "".concat(prefix.value, "__dialog-body-img-box")
          }, [vue.createVNode("img", {
            "src": showImageViewUrl.value,
            "alt": ""
          }, null)])];
        }
      });
    };

    var tipsClasses = vue.computed(function () {
      return ["".concat(UPLOAD_NAME.value, "__tips ").concat(prefix.value, "-size-s")];
    });
    var errorClasses = vue.computed(function () {
      return tipsClasses.value.concat("".concat(UPLOAD_NAME.value, "__tips-error"));
    });
    return function () {
      var triggerElement = renderTrigger();
      return vue.createVNode("div", {
        "class": "".concat(UPLOAD_NAME.value)
      }, [renderInput(), renderCustom(triggerElement), renderSingleDisplay(triggerElement), singleDraggable.value && renderDraggerTrigger(), renderImgCard(), renderFlowList(triggerElement), renderDialog(), !uploadCtx.errorMsg && showTips.value && vue.createVNode("small", {
        "class": tipsClasses.value
      }, [props2.tips]), showErrorMsg.value && vue.createVNode("small", {
        "class": errorClasses.value
      }, [uploadCtx.errorMsg])]);
    };
  }
});

exports["default"] = _Upload;
//# sourceMappingURL=upload.js.map
