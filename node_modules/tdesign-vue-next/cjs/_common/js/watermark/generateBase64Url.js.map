{"version":3,"file":"generateBase64Url.js","sources":["../../../../src/_common/js/watermark/generateBase64Url.ts"],"sourcesContent":["import { WatermarkText, WatermarkImage } from './type';\n\nexport default function generateBase64Url({\n  width,\n  height,\n  gapX,\n  gapY,\n  offsetLeft,\n  offsetTop,\n  rotate,\n  alpha,\n  watermarkContent,\n  lineSpace\n}: {\n  width: number,\n  height: number,\n  gapX:number,\n  gapY: number,\n  offsetLeft:number,\n  offsetTop:number,\n  rotate:number,\n  alpha:number,\n  watermarkContent: WatermarkText | WatermarkImage | Array<WatermarkText | WatermarkImage>,\n  lineSpace:number\n}, onFinish: (url: string) => void): string {\n  const canvas = document.createElement('canvas');\n  const ctx = canvas.getContext('2d');\n  if (!ctx) {\n    // eslint-disable-next-line no-console\n    console.warn('当前环境不支持Canvas, 无法绘制水印');\n    onFinish('');\n    return;\n  }\n  const ratio = window.devicePixelRatio || 1;\n  const canvasWidth = (gapX + width) * ratio;\n  const canvasHeight = (gapY + height) * ratio;\n\n  canvas.width = canvasWidth;\n  canvas.height = canvasHeight;\n  canvas.style.width = `${gapX + width}px`;\n  canvas.style.height = `${gapY + height}px`;\n\n  ctx.translate(offsetLeft * ratio, offsetTop * ratio);\n  ctx.rotate((Math.PI / 180) * Number(rotate));\n  ctx.globalAlpha = alpha;\n\n  const markWidth = width * ratio;\n  const markHeight = height * ratio;\n\n  ctx.fillStyle = 'transparent';\n  ctx.fillRect(0, 0, markWidth, markHeight);\n\n  const contents = Array.isArray(watermarkContent) ? watermarkContent : [{ ...watermarkContent }];\n  let top = 0;\n  contents.forEach((item: WatermarkText & WatermarkImage & { top: number }) => {\n    if (item.url) {\n      const { url, isGrayscale = false } = item;\n      // eslint-disable-next-line no-param-reassign\n      item.top = top;\n      top += height;\n      const img = new Image();\n      img.crossOrigin = 'anonymous';\n      img.referrerPolicy = 'no-referrer';\n      img.src = url;\n      img.onload = () => {\n        // ctx.filter = 'grayscale(1)';\n        ctx.drawImage(img, 0, item.top * ratio, width * ratio, height * ratio);\n        if (isGrayscale) {\n          const imgData = ctx.getImageData(0, 0, ctx.canvas.width, ctx.canvas.height);\n          const pixels = imgData.data;\n          for (let i = 0; i < pixels.length; i += 4) {\n            const lightness = (pixels[i] + pixels[i + 1] + pixels[i + 2]) / 3;\n            pixels[i] = lightness;\n            pixels[i + 1] = lightness;\n            pixels[i + 2] = lightness;\n          }\n          ctx.putImageData(imgData, 0, 0);\n        }\n        onFinish(canvas.toDataURL());\n      };\n    } else if (item.text) {\n      const {\n        text,\n        fontColor = 'rgba(0, 0, 0, 0.1)',\n        fontSize = 16,\n        fontWeight = 'normal',\n      } = item;\n      // eslint-disable-next-line no-param-reassign\n      item.top = top;\n      top += lineSpace;\n      const markSize = Number(fontSize) * ratio;\n      // TODO 后续完善font 渲染控制 目前font-family 暂时为 undefiend\n      ctx.font = `normal normal ${fontWeight} ${markSize}px/${markHeight}px undefined`;\n      ctx.textAlign = 'start';\n      ctx.textBaseline = 'top';\n      ctx.fillStyle = fontColor;\n      ctx.fillText(text, 0, item.top * ratio);\n    }\n  });\n  onFinish(canvas.toDataURL());\n}\n"],"names":["generateBase64Url","onFinish","width","height","gapX","gapY","offsetLeft","offsetTop","rotate","alpha","watermarkContent","lineSpace","canvas","document","createElement","ctx","getContext","console","warn","ratio","window","devicePixelRatio","canvasWidth","canvasHeight","style","translate","Math","PI","Number","globalAlpha","markWidth","markHeight","fillStyle","fillRect","contents","Array","isArray","top","forEach","item","url","isGrayscale","img","Image","crossOrigin","referrerPolicy","src","onload","drawImage","imgData","getImageData","pixels","data","i","length","lightness","putImageData","toDataURL","text","fontColor","fontSize","fontWeight","markSize","font","textAlign","textBaseline","fillText"],"mappings":"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"}