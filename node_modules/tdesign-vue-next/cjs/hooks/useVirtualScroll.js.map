{"version":3,"file":"useVirtualScroll.js","sources":["../../src/hooks/useVirtualScroll.ts"],"sourcesContent":["/* eslint-disable */\nimport { ref, toRefs, reactive, onMounted, computed, watch, nextTick } from 'vue';\n\n// 虚拟滚动Hooks的完整实现，只所以封装成hooks，主要是为了方便跟其他组件搭配使用，比如说表格或者下拉框\nconst useVirtualScroll = ({\n  data,\n  container,\n  fixedHeight = false,\n  lineHeight = 30,\n  bufferSize = 20,\n  threshold = 100,\n}: {\n  data: any;\n  container: any;\n  fixedHeight: boolean;\n  lineHeight: number;\n  bufferSize: number;\n  threshold: number;\n}) => {\n  const state = reactive({\n    visibleData: [],\n    cachedHeight: [],\n    cachedScrollY: [],\n  });\n  const isVirtual = computed(() => data.value.length > threshold);\n  const updateId = ref(0);\n  const trs = new Map(); // 当前展示的行元素和数据\n\n  let visibleCount = 0; // 可见的节点数量\n  let beforeScrollTop = 0; // 上一次的滚动条位置\n  let index = 0; // 偏移行数\n  let offset = 0; // 少于一行行高的偏移量\n  let start = 0; // 第一条显示的行\n  let last = 0; // 最后一条显示的行\n  // let revising = false; // 是否正在修正滚动条\n\n  const reset = () => {\n    data.value.forEach((item: any, i: number) => {\n      item.$index = i;\n      if (fixedHeight) {\n        state.cachedScrollY[i] = i * lineHeight;\n      }\n    });\n    if (!fixedHeight) {\n      state.cachedScrollY[data.value.length - 1] = undefined; // 初始化cachedScrollY数组的长度\n    }\n  };\n  reset();\n\n  // 计算虚拟滚动列表总高度，需要动态修正\n  const scrollHeight = computed(() => {\n    const { cachedHeight } = state;\n    const { length } = cachedHeight;\n    if (length) {\n      const maxScrollY = cachedHeight.reduce((sum, v) => sum + v || lineHeight, 0); // 当前总高度\n      if (cachedHeight.length === data.value.length) {\n        return maxScrollY;\n      }\n      const average = maxScrollY / cachedHeight.length; // 平均高度\n      return maxScrollY + (data.value.length - cachedHeight.length) * average; // 预估总高度\n    }\n    return isVirtual.value ? data.value.length * lineHeight : 0;\n  });\n  const translateY = computed(() => {\n    const { visibleData } = state;\n    const firstRow = visibleData[0];\n    if (firstRow) {\n      // 修复只有一个元素时存在偏移的问题\n      return visibleData.length === 1 ? 0 : state.cachedScrollY[firstRow.$index];\n    }\n    return 0;\n  });\n\n  /** 第二种实现，使用watch监听cachedScrollY也可 */\n  // const translateY = ref(0);\n  // watch(() => state.cachedScrollY, () => {\n  //   const { visibleData } = state;\n  //   const firstRow = visibleData[0];\n  //   if (firstRow) {\n  //     // 修复只有一个元素时存在偏移的问题\n  //     translateY.value = visibleData.length === 1 ? 0 : state.cachedScrollY[firstRow.$index];\n  //     return;\n  //   }\n  //   translateY.value = 0;\n  // });\n\n  // 更新可视区域的节点数据\n  const updateVisibleData = () => {\n    last = Math.min(start + visibleCount + bufferSize * 2, data.value.length);\n    state.visibleData = data.value.slice(start, last);\n  };\n  // 计算每行对应的scrollTop值\n  const calculateScrollY = () => {\n    const anchorDom = trs.get(index); // 获取锚点元素\n    if (!anchorDom) {\n      return; // 快速调整高度时，新的元素可能来不及加载，暂时跳过更新\n    }\n    const anchorDomHeight = anchorDom?.getBoundingClientRect()?.height; // 获取锚点元素的高\n    state.cachedScrollY[index] = container.value.scrollTop - offset; // 锚点元素scrollY= 容器滚动高度 - 锚点元素的offset\n    state.cachedHeight[index] = anchorDomHeight;\n\n    for (let i = index + 1; i <= state.visibleData[state.visibleData.length - 1].$index; i++) {\n      // 计算锚点后面的元素scrollY\n      const tr = trs.get(i);\n      const { height } = tr?.getBoundingClientRect() || {};\n      state.cachedHeight[i] = height;\n      const scrollY = state.cachedScrollY[i - 1] + state.cachedHeight[i - 1]; // 当前元素的y 是前一个元素的y+前一个元素高度\n      // state.cachedScrollY[i] = scrollY;\n      state.cachedScrollY.splice(i, 1, scrollY); // 兼容vue2的composition api\n    }\n\n    for (let i = index - 1; i >= state.visibleData[0].$index; i--) {\n      const tr = trs.get(i);\n      const { height } = tr?.getBoundingClientRect() || {};\n      state.cachedHeight[i] = height;\n      const scrollY = state.cachedScrollY[i + 1] - state.cachedHeight[i]; // 当前元素的y是下一个元素y - 当前元素高度\n      // state.cachedScrollY[i] = scrollY;\n      state.cachedScrollY.splice(i, 1, scrollY);\n    }\n    if (state.cachedScrollY[0] > 0) {\n      // 修正滚动过快时，滚动到顶部时，滚动条多余的问题\n      // revising = true;\n      const distance = state.cachedScrollY[0]; // 第一个元素scrollY即为多出的量\n      const length = Math.min(last, data.value.length);\n      for (let i = 0; i < length; i++) {\n        // state.cachedScrollY[i] -= distance;\n        state.cachedScrollY.splice(i, 1, state.cachedScrollY[i] - distance);\n      }\n\n      const scrollTop = state.cachedScrollY[index - 1] ? state.cachedScrollY[index - 1] + offset : offset;\n      container.value.scrollTop = scrollTop;\n      beforeScrollTop = scrollTop;\n      // revising = false;\n    }\n    // 修正拖动过快时，滚动到顶端时，滚动条不足的偏差\n    if (state.cachedScrollY[start] < 0) {\n      // revising = true;\n      const s = state.cachedHeight.slice(0, Math.max(0, index)).reduce((sum, v) => sum + v, 0) + offset;\n      container.value.scrollTop = s;\n      beforeScrollTop = s;\n      if (s === 0) {\n        index = 0;\n        offset = 0;\n      }\n      // revising = false;\n    }\n    nextTick(() => {\n      // setTimeout是为了保证快速拖动到底部时，以下逻辑能够正常执行\n      const { scrollTop, scrollHeight, clientHeight } = container.value;\n      if (scrollTop + clientHeight === scrollHeight) {\n        // 滚动到底部时，修正底部有空余的问题\n        // revising = true;\n        for (let i = last - 1; i >= start; i--) {\n          if (i === last - 1) {\n            // state.cachedScrollY[i] = scrollHeight.value - state.cachedHeight[i];\n            state.cachedScrollY.splice(i, 1, scrollHeight.value - state.cachedHeight[i]);\n          } else {\n            // state.cachedScrollY[i] = state.cachedScrollY[i + 1] - state.cachedHeight[i];\n            state.cachedScrollY.splice(i, 1, state.cachedScrollY[i + 1] - state.cachedHeight[i]);\n          }\n        }\n        // revising = false;\n      }\n    });\n  };\n\n  // 滚动时动态计算和渲染\n  const handleScroll = () => {\n    if (!isVirtual.value) return;\n    // if (revising) {\n    //   return false; // 修正滚动条时，暂停滚动逻辑\n    // }\n    const { scrollTop } = container.value;\n    let distance = scrollTop - beforeScrollTop; // 滚动差值\n    beforeScrollTop = scrollTop;\n    distance += offset;\n    let lastIndex = index;\n    // !disatance 可能为横向滚动，不做任何计算\n    if (!distance) return;\n    if (distance >= 0) {\n      // 向下滚动\n      while (lastIndex < data.value.length && distance > (state.cachedHeight[lastIndex] || lineHeight)) {\n        if (!state.cachedHeight[lastIndex]) {\n          state.cachedHeight[lastIndex] = lineHeight;\n        }\n        distance -= state.cachedHeight[lastIndex];\n        lastIndex++;\n      }\n      if (lastIndex >= data.value.length) {\n        index = data.value.length - 1;\n        offset = 0;\n      } else {\n        index = lastIndex;\n        offset = distance;\n      }\n      const { clientHeight, scrollHeight } = container.value;\n      if (scrollTop + clientHeight === scrollHeight) {\n        // 滚动条到底了\n        index = data.value.length - visibleCount + 1;\n        // calculateScrollY();\n      }\n      if (start <= index - bufferSize) {\n        // 计算第一个挂载元素\n        start = Math.min(data.value.length - visibleCount, index - bufferSize);\n        if (start < 0) {\n          start = 0;\n        }\n      }\n    } else {\n      // 向上滚动\n      while (distance < 0) {\n        lastIndex--;\n        if (!state.cachedHeight[lastIndex]) {\n          state.cachedHeight[lastIndex] = lineHeight;\n        }\n        distance += state.cachedHeight[lastIndex];\n      }\n      if (lastIndex < 0) {\n        index = 0;\n        offset = 0;\n      } else {\n        index = lastIndex;\n        offset = distance;\n      }\n      calculateScrollY();\n      if (start > index - bufferSize) {\n        // 计算第一个挂载元素\n        start = Math.max(0, index - bufferSize);\n      }\n    }\n    updateVisibleData();\n  };\n\n  !fixedHeight && watch(updateId, calculateScrollY, { flush: 'post' });\n  const handleRowMounted = () => {\n    if (!isVirtual.value) return;\n    updateId.value++;\n  };\n  watch(data, () => {\n    reset();\n    state.visibleData = [];\n    state.cachedScrollY = [];\n    state.cachedHeight = [];\n    beforeScrollTop = 0;\n    index = 0;\n    offset = 0;\n    start = 0;\n    // revising = false;\n    trs.clear();\n    if (data.value.length <= threshold) {\n      state.visibleData = data.value;\n    } else {\n      updateVisibleData();\n    }\n\n    container.value && (container.value.scrollTop = 0);\n  });\n  let mounted = false;\n  const refreshContainer = () => {\n    if (mounted) {\n      visibleCount = Math.ceil(container.value.offsetHeight / lineHeight);\n      updateVisibleData();\n    }\n  };\n  onMounted(() => {\n    if (!window || !window.IntersectionObserver) {\n      return;\n    }\n    const ob = new window.IntersectionObserver((entries) => {\n      const entry = entries[0];\n      if (entry.isIntersecting || entry.intersectionRatio) {\n        mounted = true;\n        isVirtual.value && refreshContainer();\n        ob.unobserve(container.value);\n      }\n    });\n    container.value && ob.observe(container.value);\n  });\n  return {\n    trs,\n    scrollHeight,\n    ...toRefs(state),\n    translateY,\n    handleScroll,\n    handleRowMounted,\n    refreshContainer,\n    fixedHeight,\n    calculateScrollY,\n  };\n};\nexport default useVirtualScroll;\n"],"names":["useVirtualScroll","data","container","fixedHeight","lineHeight","bufferSize","threshold","state","reactive","visibleData","cachedHeight","cachedScrollY","isVirtual","computed","value","length","updateId","ref","trs","Map","visibleCount","beforeScrollTop","index","offset","start","last","reset","forEach","item","i","$index","scrollHeight","maxScrollY","reduce","sum","v","average","translateY","firstRow","updateVisibleData","Math","min","slice","calculateScrollY","anchorDom","get","anchorDomHeight","getBoundingClientRect","height","scrollTop","tr","scrollY","splice","distance","s","max","nextTick","clientHeight","handleScroll","lastIndex","watch","flush","handleRowMounted","clear","mounted","refreshContainer","ceil","offsetHeight","onMounted","window","IntersectionObserver","ob","entries","entry","isIntersecting","intersectionRatio","unobserve","observe","toRefs"],"mappings":"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"}