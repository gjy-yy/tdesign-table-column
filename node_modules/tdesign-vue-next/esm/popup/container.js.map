{"version":3,"file":"container.js","sources":["../../src/popup/container.tsx"],"sourcesContent":["import { defineComponent, onMounted, onUnmounted, ref, Fragment, Text, watch, PropType, VNode, Teleport } from 'vue';\nimport { getAttach } from '../utils/dom';\nimport props from './props';\n\nfunction filterEmpty(children: VNode[] = []) {\n  const vnodes: VNode[] = [];\n  children.forEach((child) => {\n    if (Array.isArray(child)) {\n      vnodes.push(...child);\n    } else if (child.type === Fragment) {\n      vnodes.push(...filterEmpty(child.children as VNode[]));\n    } else {\n      vnodes.push(child);\n    }\n  });\n  return vnodes.filter(\n    (c) =>\n      !(\n        c &&\n        ((typeof Comment !== 'undefined' && c.type === Comment) ||\n          (c.type === Fragment && c.children.length === 0) ||\n          (c.type === Text && (c.children as string).trim() === ''))\n      ),\n  );\n}\n\nfunction isContentRectChanged(rect1: DOMRectReadOnly, rect2: DOMRectReadOnly) {\n  if (!rect1 || !rect2) return;\n  if (['width', 'height', 'x', 'y'].some((k) => rect1[k] !== rect2[k])) {\n    return true;\n  }\n  return false;\n}\n\nfunction observeResize(elm: HTMLElement, cb: (rect: DOMRectReadOnly) => void) {\n  if (!window?.ResizeObserver || !elm) return;\n  let prevContentRect = null as DOMRectReadOnly;\n  const ro = new ResizeObserver((entries = []) => {\n    const { contentRect } = entries[0] || {};\n    if (isContentRectChanged(contentRect, prevContentRect)) {\n      prevContentRect = contentRect;\n      cb(contentRect);\n      return;\n    }\n    // omit initial change\n    if (!prevContentRect) {\n      prevContentRect = contentRect;\n    }\n  });\n\n  if (elm.nodeType !== 1) return;\n\n  ro.observe(elm);\n  return function () {\n    ro.unobserve(elm);\n  };\n}\n\nfunction useObserveResize(elm: () => HTMLElement, cb: Parameters<typeof observeResize>[1]) {\n  let cleanOR: ReturnType<typeof observeResize>;\n  onMounted(() => {\n    cleanOR = observeResize(elm(), cb);\n  });\n  onUnmounted(() => {\n    cleanOR?.();\n  });\n}\n\n// eslint-disable-next-line vue/one-component-per-file\nconst Trigger = defineComponent({\n  emits: ['resize'],\n  data() {\n    return {\n      cleanOR: null,\n    };\n  },\n  mounted() {\n    // There is no better way to get the root element than `this.$el`\n    this.cleanOR = observeResize(this.$el, () => {\n      this.$emit('resize');\n    });\n  },\n  unmounted() {\n    this.cleanOR?.();\n  },\n  render() {\n    const children = filterEmpty(this.$slots.default());\n    if (children.length > 1 || children[0]?.type === Text) {\n      return <span>{children}</span>;\n    }\n    return children[0];\n  },\n});\n\n// eslint-disable-next-line vue/one-component-per-file\nconst Content = defineComponent({\n  emits: ['resize'],\n  setup(props, { emit }) {\n    const el = ref(null);\n    useObserveResize(\n      () => el.value.children[0],\n      () => {\n        emit('resize');\n      },\n    );\n    return { el };\n  },\n  render() {\n    return (\n      <div ref=\"el\" style=\"position: absolute; top: 0px; left: 0px; width: 100%\">\n        {this.$slots.default()}\n      </div>\n    );\n  },\n});\n\n// eslint-disable-next-line vue/one-component-per-file\nexport default defineComponent({\n  inheritAttrs: false,\n  props: {\n    parent: Object,\n    visible: Boolean,\n    attach: props.attach,\n    forwardRef: Function as PropType<(el: HTMLElement) => void>,\n  },\n  emits: ['resize', 'contentMounted'],\n  setup(props, { emit }) {\n    const triggerRef = ref<VNode & { $el: HTMLElement }>(null);\n    const mountContent = ref(false);\n\n    onMounted(() => {\n      requestAnimationFrame(() => {\n        mountContent.value = props.visible;\n      });\n      props.forwardRef(triggerRef.value.$el);\n    });\n\n    watch(\n      () => props.visible,\n      (visible) => {\n        if (visible) {\n          mountContent.value = props.visible;\n        }\n      },\n    );\n\n    return {\n      mountContent,\n      triggerRef,\n      unmountContent() {\n        mountContent.value = false;\n      },\n      emitResize: () => {\n        emit('resize');\n      },\n      emitContentMounted: () => {\n        emit('contentMounted');\n      },\n    };\n  },\n  render() {\n    return (\n      <Fragment>\n        <Trigger\n          {...{\n            class: this.$attrs.class,\n          }}\n          ref=\"triggerRef\"\n          onResize={this.emitResize}\n        >\n          {this.$slots.default()}\n        </Trigger>\n        {this.mountContent && (\n          <Teleport to={getAttach(this.attach, this.triggerRef?.$el)}>\n            <Content onResize={this.emitResize} onVnodeMounted={this.emitContentMounted}>\n              {this.$slots.content && this.$slots.content()}\n            </Content>\n          </Teleport>\n        )}\n      </Fragment>\n    );\n  },\n});\n"],"names":["filterEmpty","children","vnodes","forEach","child","Array","isArray","push","type","Fragment","filter","c","Comment","length","Text","trim","isContentRectChanged","rect1","rect2","some","k","observeResize","elm","cb","window","ResizeObserver","prevContentRect","ro","entries","contentRect","nodeType","observe","unobserve","useObserveResize","cleanOR","onMounted","onUnmounted","Trigger","defineComponent","emits","data","mounted","$el","$emit","unmounted","render","$slots","_createVNode","Content","setup","props","emit","el","ref","value","inheritAttrs","parent","Object","visible","Boolean","attach","forwardRef","Function","triggerRef","mountContent","requestAnimationFrame","watch","unmountContent","emitResize","emitContentMounted","_Fragment","_mergeProps","$attrs","getAttach","content"],"mappings":"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"}