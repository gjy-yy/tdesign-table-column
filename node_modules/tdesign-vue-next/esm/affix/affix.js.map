{"version":3,"file":"affix.js","sources":["../../src/affix/affix.tsx"],"sourcesContent":["import { ref, watch, nextTick, onMounted, onBeforeUnmount, defineComponent, onActivated, onDeactivated } from 'vue';\nimport isFunction from 'lodash/isFunction';\nimport { on, off, getScrollContainer } from '../utils/dom';\nimport props from './props';\nimport { ScrollContainerElement } from '../common';\nimport { usePrefixClass } from '../hooks/useConfig';\nimport { useTNodeJSX } from '../hooks/tnode';\n\nexport default defineComponent({\n  name: 'TAffix',\n  props,\n  emits: ['fixedChange'],\n  setup(props, context) {\n    const COMPONENT_NAME = usePrefixClass('affix');\n    const renderTNodeJSX = useTNodeJSX();\n\n    const affixWrapRef = ref<HTMLElement>(null);\n    const affixRef = ref<HTMLElement>(null);\n    const placeholderEL = ref(document.createElement('div')); // 占位节点\n    const ticking = ref(false);\n    const binded = ref(false);\n\n    const scrollContainer = ref<ScrollContainerElement>();\n\n    const handleScroll = () => {\n      if (!ticking.value) {\n        window.requestAnimationFrame(() => {\n          const {\n            top: wrapToTop,\n            width: wrapWidth,\n            height: wrapHeight,\n          } = affixWrapRef.value.getBoundingClientRect() ?? { top: 0, width: 0, height: 0 }; // top = 节点到页面顶部的距离，包含 scroll 中的高度\n\n          let containerTop = 0; // containerTop = 容器到页面顶部的距离\n          if (scrollContainer.value instanceof HTMLElement) {\n            containerTop = scrollContainer.value.getBoundingClientRect().top;\n          }\n\n          let fixedTop: number | false; // 0 -1 false 都有具体的意义\n          const calcTop = wrapToTop - containerTop; // 节点顶部到 container 顶部的距离\n\n          const containerHeight =\n            scrollContainer.value[scrollContainer.value instanceof Window ? 'innerHeight' : 'clientHeight'] -\n            wrapHeight;\n          const calcBottom = containerTop + containerHeight - props.offsetBottom; // 计算 bottom 相对应的 top 值\n\n          if (props.offsetTop !== undefined && calcTop <= props.offsetTop) {\n            // top 的触发\n            fixedTop = containerTop + props.offsetTop;\n          } else if (props.offsetBottom !== undefined && wrapToTop >= calcBottom) {\n            // bottom 的触发\n            fixedTop = calcBottom;\n          } else {\n            fixedTop = false;\n          }\n\n          if (affixRef.value) {\n            const affixed = fixedTop !== false;\n            const placeholderStatus = affixWrapRef.value.contains(placeholderEL.value);\n\n            if (affixed) {\n              affixRef.value.className = COMPONENT_NAME.value;\n              affixRef.value.style.top = `${fixedTop}px`;\n              affixRef.value.style.width = `${wrapWidth}px`;\n              affixRef.value.style.height = `${wrapHeight}px`;\n\n              if (props.zIndex) {\n                affixRef.value.style.zIndex = `${props.zIndex}`;\n              }\n\n              if (!placeholderStatus) {\n                placeholderEL.value.style.width = `${wrapWidth}px`;\n                placeholderEL.value.style.height = `${wrapHeight}px`;\n                affixWrapRef.value.appendChild(placeholderEL.value);\n              }\n            } else {\n              affixRef.value.removeAttribute('class');\n              affixRef.value.removeAttribute('style');\n              placeholderStatus && placeholderEL.value.remove();\n            }\n\n            context.emit('fixedChange', affixed, { top: Number(fixedTop) });\n            if (isFunction(props.onFixedChange)) props.onFixedChange(affixed, { top: Number(fixedTop) });\n          }\n\n          ticking.value = false;\n        });\n        ticking.value = true;\n      }\n    };\n\n    const bindScroll = async () => {\n      await nextTick();\n      if (binded.value) return;\n      scrollContainer.value = getScrollContainer(props.container);\n      on(scrollContainer.value, 'scroll', handleScroll);\n      on(window, 'resize', handleScroll);\n      binded.value = true;\n    };\n\n    const unbindScroll = () => {\n      if (!scrollContainer.value || !binded.value) return;\n      off(scrollContainer.value, 'scroll', handleScroll);\n      off(window, 'resize', handleScroll);\n      binded.value = false;\n    };\n\n    watch(\n      () => props.offsetTop,\n      () => {\n        handleScroll();\n      },\n    );\n\n    watch(\n      () => props.offsetBottom,\n      () => {\n        handleScroll();\n      },\n    );\n\n    watch(\n      () => props.zIndex,\n      () => {\n        handleScroll();\n      },\n    );\n\n    onMounted(bindScroll);\n\n    onActivated(bindScroll);\n\n    onDeactivated(unbindScroll);\n\n    onBeforeUnmount(unbindScroll);\n\n    return {\n      affixWrapRef,\n      affixRef,\n      bindScroll,\n      unbindScroll,\n      handleScroll,\n      scrollContainer,\n      renderTNodeJSX,\n    };\n  },\n  render() {\n    return (\n      <div ref=\"affixWrapRef\">\n        <div ref=\"affixRef\">{this.renderTNodeJSX('default')}</div>\n      </div>\n    );\n  },\n});\n"],"names":["defineComponent","name","props","emits","setup","context","COMPONENT_NAME","usePrefixClass","renderTNodeJSX","useTNodeJSX","affixWrapRef","ref","affixRef","placeholderEL","document","createElement","ticking","binded","scrollContainer","handleScroll","value","window","requestAnimationFrame","getBoundingClientRect","top","width","height","wrapToTop","wrapWidth","wrapHeight","containerTop","HTMLElement","fixedTop","calcTop","containerHeight","Window","calcBottom","offsetBottom","offsetTop","affixed","placeholderStatus","contains","className","style","zIndex","appendChild","removeAttribute","remove","emit","Number","isFunction","onFixedChange","bindScroll","nextTick","getScrollContainer","container","on","unbindScroll","off","watch","onMounted","onActivated","onDeactivated","onBeforeUnmount","render","_createVNode"],"mappings":"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"}